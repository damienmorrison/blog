<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="/feed.xml" rel="self" type="application/atom+xml" /><link href="/" rel="alternate" type="text/html" /><updated>2023-07-17T16:23:00+00:00</updated><id>/feed.xml</id><title type="html">Sitecore Techdeck - Damien Morrison</title><entry><title type="html">Integrating with Sitecore Consent Manager using Next.js</title><link href="/2023-06-28-integrating-with-sitecore-consent-manager/" rel="alternate" type="text/html" title="Integrating with Sitecore Consent Manager using Next.js" /><published>2023-06-29T00:00:00+00:00</published><updated>2023-06-29T00:00:00+00:00</updated><id>/integrating-with-sitecore-consent-manager</id><content type="html" xml:base="/2023-06-28-integrating-with-sitecore-consent-manager/"><![CDATA[<p>Sitecore introduced the <a href="https://doc.sitecore.com/xp/en/developers/102/sitecore-experience-platform/manage-a-contact-s-tracking-consent-choices.html">Tracking Consent API</a> for managing tracking consent since version 10.0. You no longer have to fiddle around with the code yourself to  remove the SC_ANALYTICS_GLOBAL_COOKIE. Now you simply call the Consent Manager API and Sitecore takes care of the rest. One small disadvantage is that Sitecore stores the consent in a new cookie SC_TRACKING_CONSENT. Not ideal when you’re normally try to reduce the use of cookies but this cookie merely stores the user’s consent choice and cannot be used to identify the user.</p>

<p>Sounds easy enough, but how do the integrations to the API look in different setups?</p>

<blockquote>
  <p>This blog post focuses on a headless Sitecore XP setup so it won’t be relevant for XM Cloud.</p>
</blockquote>

<p>It’s definitely food for thought how this would be done in XM Cloud. Sitecore must be exposing their own API for these scenarios? A blog post for another day.</p>

<h2 id="sitecore-integration">Sitecore Integration</h2>

<p>On the side of Sitecore, it’s a very painless integration with Sitecore’s Consent Manager. See <a href="https://doc.sitecore.com/xp/en/developers/102/sitecore-experience-platform/manage-a-contact-s-tracking-consent-choices.html">Sitecore’s documentation</a> for a full run down, but essentially you just need to call the <em>GiveConsent</em> and <em>RevokeConsent</em> methods of the Consent Manager Service respectively.</p>

<p>Sending through null to these calls will instruct Sitecore to use the <em>IContentStorage</em> service to identify consent, which, by default, uses the cookie mentioned above, the SC_TRACKING_CONSENT cookie.</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="nf">RoutePrefix</span><span class="p">(</span><span class="s">"api/trackingconsent"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">TrackingConsentController</span> <span class="p">:</span> <span class="n">Controller</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IConsentManager</span> <span class="n">_consentManager</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">TrackingConsentController</span><span class="p">(</span><span class="n">IConsentManager</span> <span class="n">consentManager</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">_consentManager</span> <span class="p">=</span> <span class="n">consentManager</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">[</span><span class="n">HttpPatch</span><span class="p">]</span>
    <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"give"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">GiveConsent</span><span class="p">()</span>
    <span class="p">{</span>
	    <span class="k">this</span><span class="p">.</span><span class="n">_consentManager</span><span class="p">.</span><span class="nf">GiveConsent</span><span class="p">(</span><span class="k">null</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">JsonResult</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Data</span> <span class="p">=</span> <span class="k">new</span> <span class="p">{</span> <span class="n">Message</span> <span class="p">=</span> <span class="s">"Consent has been granted"</span> <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">}</span>

    <span class="p">[</span><span class="n">HttpPatch</span><span class="p">]</span>
    <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"revoke"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">RevokeConsent</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">_consentManager</span><span class="p">.</span><span class="nf">RevokeConsent</span><span class="p">(</span><span class="k">null</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">new</span> <span class="n">JsonResult</span>
        <span class="p">{</span>
	        <span class="n">Data</span> <span class="p">=</span> <span class="k">new</span> <span class="p">{</span> <span class="n">Message</span> <span class="p">=</span> <span class="s">"Consent has been revoked"</span> <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>That’s pretty much all we need to do. Sitecore handles the rest internally.</p>

<p>In this case of GiveConsent, Sitecore will start (or continue) tracking and will update the ContentStorage (the SC_TRACKING_CONSENT cookie by default).</p>

<p>You can check that it’s working by inspecting the response headers on the request. You should see two cookies being set.</p>

<table>
  <thead>
    <tr>
      <th>Key</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Set-Cookie</td>
      <td>SC_TRACKING_CONSENT=choice; expires=Mon, 27-Jun-2033 14:09:43 GMT; path=/; secure; SameSite=None</td>
    </tr>
    <tr>
      <td>Set-Cookie</td>
      <td>SC_ANALYTICS_GLOBAL_COOKIE=id|False; expires=Mon, 27-Jun-2033 14:09:43 GMT; path=/; secure; HttpOnly; SameSite=None</td>
    </tr>
  </tbody>
</table>

<p>In the case of Revoke, Sitecore needs to carry out its due diligence to ensure any tracking is stopped and any trace of that contact is removed. Equally important, is that the SC_ANALYTICS_GLOBAL_COOKIE is removed.</p>

<p>This again can be checked by inspecting the headers. This time you will also see two headers, but the SC_ANALYTICS_GLOBAL_COOKIE should be expired (to a time in the past). The browser will then pick up the expiry date and remove it.</p>

<table>
  <thead>
    <tr>
      <th>Key</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Set-Cookie</td>
      <td>SC_TRACKING_CONSENT=choice; expires=Mon, 27-Jun-2033 14:09:43 GMT; path=/; secure; SameSite=None</td>
    </tr>
    <tr>
      <td>Set-Cookie</td>
      <td>SC_ANALYTICS_GLOBAL_COOKIE=id|False; expires=Thu, 29-Jun-2023 15:26:18 GMT; path=/; secure; HttpOnly; SameSite=None</td>
    </tr>
  </tbody>
</table>

<h2 id="cookiebot-integration-in-next-js">Cookiebot Integration in Next JS</h2>

<p>Once the Give/Revoke endpoints are in place we will need to integrate with the Cookie Management Tool so that the appropriate endpoint is called when the user makes their selection.</p>

<p>I will demonstrate the integration with Cookiebot, however the following approach will be the same for any cookie management tool:</p>
<ul>
  <li>Handle the user’s tracking choice by hooking into the Cookie Management Tool’s click events or callbacks. You’ll also need to figure out whether the user has consented to tracking.</li>
  <li>Call the appropriate give or revoke endpoint according to the user’s selection.</li>
  <li>Add a rewrite entry in the next.config.js to proxy the request from the node server to Sitecore. You could also write a custom route handler if you need to do any other processing, i.e. logging.</li>
</ul>

<h3 id="handle-users-tracking-choice">Handle user’s tracking choice</h3>

<p>Cookiebot provides decent enough <a href="https://www.cookiebot.com/en/developer">developer documentation</a> where we can find everything we need.</p>
<ul>
  <li>To react to the user’s selection we’ll use the <em>CookiebotOnAccept</em> and <em>CookiebotOnDecline</em> event listeners.</li>
  <li>To determine if they have consented to tracking, we need to check their selection for Statistics, as this category best describes the type of tracking that Sitecore does. To do this, we’ll check the <em>consent.statistics</em> property which is added to the global namespace on the client.</li>
</ul>

<h3 id="register-the-click-event-in-nextjs">Register the click event in Next.js</h3>

<p>To register the client event in Next.js, we can use the useEffect React hook. Be sure to pass an empty array as a dependency to useEffect. We don’t need anything other than a one-time registration here.  We can also remove the event listeners by utilising the return function.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
	<span class="kd">const</span> <span class="nx">cookieBotAcceptEvent</span> <span class="o">=</span> <span class="k">async </span><span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
		<span class="k">await</span> <span class="nf">handleCookieBotAccept</span><span class="p">(</span><span class="nx">currentSite</span><span class="p">);</span>
	<span class="p">};</span>
	  
	<span class="kd">const</span> <span class="nx">cookieBotDeclineEvent</span> <span class="o">=</span> <span class="k">async </span><span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
		<span class="k">await</span> <span class="nf">handleCookieBotDecline</span><span class="p">(</span><span class="nx">currentSite</span><span class="p">);</span>
	<span class="p">};</span>
	
	<span class="k">if </span><span class="p">(</span><span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">undefined</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
		<span class="nb">window</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">CookiebotOnAccept</span><span class="dl">'</span><span class="p">,</span> <span class="nx">cookieBotAcceptEvent</span><span class="p">);</span>
		<span class="nb">window</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">CookiebotOnDecline</span><span class="dl">'</span><span class="p">,</span> <span class="nx">cookieBotDeclineEvent</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="k">return </span><span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
		<span class="nb">window</span><span class="p">.</span><span class="nf">removeEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">CookiebotOnAccept</span><span class="dl">'</span><span class="p">,</span> <span class="nx">cookieBotAcceptEvent</span><span class="p">);</span>
		<span class="nb">window</span><span class="p">.</span><span class="nf">removeEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">CookiebotOnDecline</span><span class="dl">'</span><span class="p">,</span> <span class="nx">cookieBotDeclineEvent</span><span class="p">);</span>
	<span class="p">};</span>
<span class="p">},</span> <span class="p">[]);</span>
</code></pre></div></div>

<h3 id="handle-the-click-events-and-call-the-endpoints">Handle the Click Events and call the endpoints</h3>

<p>Once an event has been triggered, we still need to determine if a consent choice has actually been made for statistics.  A little bit of logic is required to handle the different choices. Ensure to read the documentation on which selection fires which event.</p>

<p>Once we’re finally nutted down what the choice was, we can call the give/revoke endpoints.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">giveConsent</span> <span class="o">=</span> <span class="k">async </span><span class="p">(</span><span class="nx">site</span><span class="p">:</span> <span class="nx">string</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="p">{</span>
	<span class="k">await</span> <span class="nf">fetch</span><span class="p">(</span><span class="s2">`/api/trackingConsent/give?sc_site=</span><span class="p">${</span><span class="nx">site</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span> <span class="p">{</span>
		<span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">PATCH</span><span class="dl">'</span><span class="p">,</span>
	<span class="p">}).</span><span class="k">catch</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
		<span class="nx">console</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Error giving consent:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
	<span class="p">});</span>
<span class="p">};</span>

<span class="kd">const</span> <span class="nx">revokeConsent</span> <span class="o">=</span> <span class="k">async </span><span class="p">(</span><span class="nx">site</span><span class="p">:</span> <span class="nx">string</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="p">{</span>
	<span class="k">await</span> <span class="nf">fetch</span><span class="p">(</span><span class="s2">`/api/trackingConsent/revoke?sc_site=</span><span class="p">${</span><span class="nx">site</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span> <span class="p">{</span>
		<span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">PATCH</span><span class="dl">'</span><span class="p">,</span>
	<span class="p">}).</span><span class="k">catch</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
		<span class="nx">console</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Error revoking consent:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
	<span class="p">});</span>
<span class="p">};</span>
  
<span class="k">export</span> <span class="kd">const</span> <span class="nx">handleCookieBotAccept</span> <span class="o">=</span> <span class="k">async </span><span class="p">(</span><span class="nx">site</span><span class="p">:</span> <span class="nx">string</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="p">{</span>
	<span class="c1">//is fired on buttons "Allow all cookies" &amp; "Allow individual selection"</span>
	<span class="k">if </span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">Cookiebot</span><span class="p">?.</span><span class="nx">changed</span> <span class="o">&amp;&amp;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Cookiebot</span><span class="p">.</span><span class="nx">consent</span><span class="p">.</span><span class="nx">statistics</span><span class="p">)</span> <span class="p">{</span>
		<span class="nf">giveConsent</span><span class="p">(</span><span class="nx">site</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> 
		<span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">Cookiebot</span><span class="p">?.</span><span class="nx">changed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">Cookiebot</span><span class="p">.</span><span class="nx">consent</span><span class="p">.</span><span class="nx">statistics</span><span class="p">)</span> <span class="p">{</span>
			<span class="nf">revokeConsent</span><span class="p">(</span><span class="nx">site</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">};</span>
  
<span class="k">export</span> <span class="kd">const</span> <span class="nx">handleCookieBotDecline</span> <span class="o">=</span> <span class="k">async </span><span class="p">(</span><span class="nx">site</span><span class="p">:</span> <span class="nx">string</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="p">{</span>
	<span class="c1">//is fired on buttons "Withdraw you consent" &amp; "Use necessary cookies only"</span>
	<span class="k">if </span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">Cookiebot</span><span class="p">?.</span><span class="nx">changed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">Cookiebot</span><span class="p">.</span><span class="nx">consent</span><span class="p">.</span><span class="nx">statistics</span><span class="p">)</span> <span class="p">{</span>
		<span class="nf">revokeConsent</span><span class="p">(</span><span class="nx">site</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<h3 id="proxy-request-to-sitecore">Proxy request to Sitecore</h3>

<p>The final part of the flow is to ensure that Next.js proxy ferries the request to Sitecore and back. This is a good time to add the SC API Key since the proxy runs server-side.  Here we can add the following entry to the Next.js rewrite module in next.config.js.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
	<span class="nl">source</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/api/trackingConsent/:path*</span><span class="dl">'</span><span class="p">,</span>
	<span class="nx">destination</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">jssConfig</span><span class="p">.</span><span class="nx">sitecoreApiHost</span><span class="p">}</span><span class="s2">/macaw/api/trackingconsent/:path*?sc_apikey=</span><span class="p">${</span><span class="nx">jssConfig</span><span class="p">.</span><span class="nx">sitecoreApiKey</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
<span class="p">},</span>
</code></pre></div></div>

<h4 id="trusted-connection-issue">Trusted Connection Issue</h4>

<p>If you see this error from the Next.js Server, it’s most likely a trusted connection issue, since your local server runs unsecured on http and Sitecore on SSL with https. Since your website will (hopefully) be running on SSL this should only be a development problem. I’ve read that setting NODE_TLS_REJECT_UNAUTHORIZED to 0 in Node should get around this but it wasn’t enough for me. The easiest thing to do is to set up a http binding for your local Sitecore instance.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- error Error: unable to verify the first certificate
    at TLSSocket.onConnectSecure <span class="o">(</span>node:_tls_wrap:1540:34<span class="o">)</span>
    at TLSSocket.emit <span class="o">(</span>node:events:513:28<span class="o">)</span>
    at TLSSocket._finishInit <span class="o">(</span>node:_tls_wrap:959:8<span class="o">)</span>
    at ssl.onhandshakedone <span class="o">(</span>node:_tls_wrap:743:12<span class="o">)</span> <span class="o">{</span>
  code: <span class="s1">'UNABLE_TO_VERIFY_LEAF_SIGNATURE'</span>
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>As we can see, Sitecore certainly does a lot of heavy-lifting for us here, but there is still come integration work to be done in Next.JS to handle the events and notify Sitecore. A word of warning, there have been reports that Sitecore is not always respecting the consent choice being stored. See the blog post by George Change <a href="https://georgechang.io/posts/2023/making-sitecore-xp-compliant-with-gdpr-and-other-privacy-laws-because-its-not/">here</a>. This is no doubt an issue that Sitecore will  sort out soon.</p>]]></content><author><name>Damien Morrison</name></author><category term="Sitecore" /><category term="Sitecore XP" /><category term="Next JS" /><category term="Headless" /><category term="Blog" /><summary type="html"><![CDATA[How to inform Sitecore of a user's tracking consent using Sitecore XP and Next.js]]></summary></entry></feed>